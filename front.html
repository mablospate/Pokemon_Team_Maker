<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon Team Builder</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1923;
            --card: #1a2634;
            --card2: #243447;
            --accent: #ef4444;
            --accent2: #f97316;
            --accent-soft: rgba(239, 68, 68, .12);
            --text: #e2e8f0;
            --muted: #64748b;
            --border: #2d3f52;
            --success: #22c55e
        }

        * {
            box-sizing: border-box
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            margin: 0
        }

        a {
            color: var(--accent);
            text-decoration: none
        }

        .navbar-custom {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border-bottom: 1px solid var(--border);
            padding: .75rem 0
        }

        .brand {
            font-weight: 700;
            font-size: 1.3rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: .5rem
        }

        .brand img {
            width: 28px;
            height: 28px
        }

        .sec {
            display: none
        }

        .sec.on {
            display: block
        }

        .card-dark {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden
        }

        .card-dark .card-body {
            padding: 1.5rem
        }

        @media(max-width:576px) {
            .card-dark .card-body {
                padding: 1rem
            }
        }

        .form-control-dark {
            background: var(--card2);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            padding: .6rem .9rem;
            transition: border-color .2s
        }

        .form-control-dark:focus {
            background: var(--card2);
            color: var(--text);
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft)
        }

        .form-control-dark::placeholder {
            color: var(--muted)
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border: none;
            color: #fff;
            font-weight: 600;
            border-radius: 8px;
            padding: .6rem 1.2rem;
            transition: transform .15s, box-shadow .15s
        }

        .btn-primary-custom:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, .3);
            color: #fff
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            padding: .5rem 1rem;
            transition: all .15s
        }

        .btn-ghost:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-soft)
        }

        .btn-ghost-danger:hover {
            border-color: var(--accent);
            color: var(--accent)
        }

        .btn-ghost-blue:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: rgba(59, 130, 246, .1)
        }

        .nav-pills-custom .nav-link {
            color: var(--muted);
            border-radius: 8px;
            padding: .5rem 1.2rem;
            font-weight: 500;
            transition: all .2s
        }

        .nav-pills-custom .nav-link.active {
            background: var(--accent-soft);
            color: var(--accent)
        }

        .nav-pills-custom .nav-link:not(.active):hover {
            color: var(--text)
        }

        .team-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .team-card:hover {
            border-color: var(--accent);
            background: var(--card2);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, .3)
        }

        .team-card .team-name {
            font-weight: 600;
            font-size: 1.05rem
        }

        .team-card .team-id {
            color: var(--muted);
            font-size: .8rem;
            background: var(--card2);
            padding: .2rem .6rem;
            border-radius: 6px
        }

        .team-card:hover .team-id {
            background: var(--accent-soft);
            color: var(--accent)
        }

        .pk-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all .2s;
            height: 100%
        }

        .pk-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3)
        }

        .pk-card .pk-img-wrap {
            background: linear-gradient(135deg, var(--card2), var(--bg));
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px
        }

        .pk-card img {
            width: 90px;
            height: 90px;
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, .4));
            transition: transform .2s
        }

        .pk-card:hover img {
            transform: scale(1.1)
        }

        .pk-card .pk-info {
            padding: .75rem 1rem
        }

        .pk-card .pk-name {
            font-weight: 700;
            font-size: 1rem;
            margin: 0
        }

        .pk-card .pk-species {
            color: var(--muted);
            font-size: .85rem
        }

        .pk-card .pk-level {
            display: inline-block;
            background: var(--accent-soft);
            color: var(--accent);
            font-weight: 600;
            font-size: .75rem;
            padding: .15rem .5rem;
            border-radius: 6px;
            margin-top: .3rem
        }

        .pk-card .pk-remove {
            width: 100%;
            border: none;
            background: transparent;
            color: var(--muted);
            padding: .5rem;
            border-top: 1px solid var(--border);
            transition: all .15s;
            cursor: pointer;
            font-size: .85rem
        }

        .pk-card .pk-remove:hover {
            color: var(--accent);
            background: var(--accent-soft)
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--muted)
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            opacity: .4
        }

        .empty-state p {
            font-size: 1.05rem
        }

        .modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text)
        }

        .modal-header {
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem
        }

        .modal-footer {
            border-top: 1px solid var(--border);
            padding: 1rem 1.5rem
        }

        .modal-title {
            font-weight: 700
        }

        .btn-close {
            filter: invert(1) grayscale(1) brightness(2)
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: .5rem;
            color: var(--text);
            font-size: .9rem
        }

        .user-badge i {
            color: var(--accent)
        }

        .btn-logout {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, .2);
            color: rgba(255, 255, 255, .7);
            border-radius: 8px;
            padding: .3rem .75rem;
            font-size: .8rem;
            transition: all .15s;
            cursor: pointer
        }

        .btn-logout:hover {
            border-color: var(--accent);
            color: var(--accent)
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
            gap: .5rem
        }

        .section-header h4 {
            margin: 0;
            font-weight: 700;
            font-size: 1.35rem
        }

        .add-pokemon-form {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1.5rem
        }

        .add-pokemon-form h6 {
            font-weight: 600;
            margin-bottom: .75rem;
            color: var(--text)
        }

        .toast {
            border-radius: 10px
        }

        .fade-in {
            animation: fadeIn .3s ease
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @media(max-width:576px) {
            .section-header h4 {
                font-size: 1.15rem
            }

            .team-card {
                padding: .75rem 1rem
            }

            .pk-card img {
                width: 70px;
                height: 70px
            }

            .add-pokemon-form .row {
                gap: .5rem !important
            }

            .add-pokemon-form .col,
            .add-pokemon-form .col-auto,
            .add-pokemon-form .col-3 {
                flex: 0 0 100%;
                max-width: 100%
            }
        }

        .main-nav {
            display: flex;
            gap: .5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: .75rem
        }

        .main-nav .nav-btn {
            background: transparent;
            border: none;
            color: var(--muted);
            font-weight: 600;
            font-size: .95rem;
            padding: .5rem 1rem;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all .2s;
            border-bottom: 2px solid transparent
        }

        .main-nav .nav-btn:hover {
            color: var(--text)
        }

        .main-nav .nav-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: var(--accent-soft)
        }

        .role-badge {
            font-size: .7rem;
            font-weight: 600;
            padding: .15rem .5rem;
            border-radius: 6px;
            text-transform: uppercase
        }

        .role-user {
            background: rgba(100, 116, 139, .2);
            color: #94a3b8
        }

        .role-moderator {
            background: rgba(59, 130, 246, .15);
            color: #60a5fa
        }

        .role-admin {
            background: rgba(239, 68, 68, .15);
            color: #ef4444
        }

        .user-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0
        }

        .user-table th {
            color: var(--muted);
            font-size: .8rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: .75rem 1rem;
            border-bottom: 1px solid var(--border);
            text-align: left
        }

        .user-table td {
            padding: .75rem 1rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle
        }

        .user-table tr:hover td {
            background: var(--card2)
        }

        .select-dark {
            background: var(--card2);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            padding: .3rem .5rem;
            font-size: .85rem
        }

        .select-dark:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px var(--accent-soft)
        }

        .mod-search {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem
        }
    </style>
</head>

<body>

    <!-- NAV -->
    <nav class="navbar-custom">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="brand"><span>⚡</span> Pokémon Team Builder</div>
            <div id="nav-user" class="d-none">
                <div class="user-badge">
                    <i class="fa-solid fa-user-circle"></i>
                    <span id="nav-username"></span>
                    <span id="nav-role-badge" class="role-badge"></span>
                    <button type="button" class="btn-logout ms-2" id="btn-logout"><i
                            class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-4" style="max-width:820px">

        <!-- Toast -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:9999">
            <div id="toast" class="toast align-items-center border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body" id="toast-msg"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>

        <!-- AUTH -->
        <div id="sec-auth" class="sec on fade-in">
            <div class="row justify-content-center mt-4">
                <div class="col-md-5 col-11">
                    <div class="card-dark">
                        <div class="card-body">
                            <ul class="nav nav-pills nav-pills-custom mb-4 justify-content-center gap-2">
                                <li class="nav-item"><a class="nav-link active" id="tab-login"
                                        href="javascript:void(0)">Iniciar sesión</a></li>
                                <li class="nav-item"><a class="nav-link" id="tab-register"
                                        href="javascript:void(0)">Registrarse</a></li>
                            </ul>
                            <div id="form-login">
                                <div class="mb-3">
                                    <label class="form-label small" style="color:var(--muted)"
                                        for="l-user">Usuario</label>
                                    <input id="l-user" class="form-control form-control-dark"
                                        placeholder="Tu nombre de usuario">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small" style="color:var(--muted)"
                                        for="l-pass">Contraseña</label>
                                    <input id="l-pass" type="password" class="form-control form-control-dark"
                                        placeholder="Tu contraseña">
                                </div>
                                <button type="button" class="btn btn-primary-custom w-100"
                                    id="btn-login">Entrar</button>
                            </div>
                            <div id="form-register" class="d-none">
                                <div class="mb-3">
                                    <label class="form-label small" style="color:var(--muted)"
                                        for="r-user">Usuario</label>
                                    <input id="r-user" class="form-control form-control-dark"
                                        placeholder="Elige un nombre">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small" style="color:var(--muted)"
                                        for="r-pass">Contraseña</label>
                                    <input id="r-pass" type="password" class="form-control form-control-dark"
                                        placeholder="Elige una contraseña">
                                </div>
                                <button type="button" class="btn btn-primary-custom w-100" id="btn-register">Crear
                                    cuenta</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN -->
        <div id="sec-main" class="sec fade-in">

            <!-- Main navigation tabs -->
            <div class="main-nav" id="main-nav">
                <button type="button" class="nav-btn active" data-view="teams"><i
                        class="fa-solid fa-layer-group me-1"></i> Mis Equipos</button>
                <button type="button" class="nav-btn d-none" id="nav-mod" data-view="mod"><i
                        class="fa-solid fa-shield-halved me-1"></i> Moderación</button>
                <button type="button" class="nav-btn d-none" id="nav-admin" data-view="admin"><i
                        class="fa-solid fa-crown me-1"></i> Administración</button>
            </div>

            <!-- Teams -->
            <div id="v-teams">
                <div class="section-header">
                    <h4><i class="fa-solid fa-layer-group me-2" style="color:var(--accent)"></i>Mis Equipos</h4>
                    <button type="button" class="btn btn-primary-custom btn-sm" id="btn-newteam"><i
                            class="fa-solid fa-plus me-1"></i> Nuevo equipo</button>
                </div>
                <div id="teams-list" class="d-flex flex-column gap-2"></div>
                <div id="no-teams" class="empty-state d-none">
                    <i class="fa-solid fa-box-open"></i>
                    <p>No tienes equipos aún.<br>¡Crea tu primer equipo!</p>
                </div>
            </div>

            <!-- Team detail -->
            <div id="v-team" class="d-none">
                <button type="button" class="btn btn-ghost btn-sm mb-3" id="btn-back"><i
                        class="fa-solid fa-arrow-left me-1"></i> Volver</button>
                <div class="section-header">
                    <h4 id="team-name"></h4>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-ghost btn-ghost-blue btn-sm" id="btn-rename"><i
                                class="fa-solid fa-pen me-1"></i> Renombrar</button>
                        <button type="button" class="btn btn-ghost btn-ghost-danger btn-sm" id="btn-delteam"><i
                                class="fa-solid fa-trash me-1"></i> Eliminar</button>
                    </div>
                </div>
                <div id="pokemon-list" class="row g-3"></div>
                <div id="no-pokemon" class="empty-state d-none">
                    <i class="fa-solid fa-ghost"></i>
                    <p>Este equipo está vacío.<br>¡Añade tu primer Pokémon!</p>
                </div>
                <div id="add-pokemon-section" class="add-pokemon-form">
                    <h6><i class="fa-solid fa-plus-circle me-1" style="color:var(--accent)"></i> Añadir Pokémon</h6>
                    <div class="row g-2 align-items-end">
                        <div class="col"><input id="pk-name" class="form-control form-control-dark form-control-sm"
                                placeholder="Nombre (ej: Sparky)"></div>
                        <div class="col"><input id="pk-species" class="form-control form-control-dark form-control-sm"
                                placeholder="Especie (ej: pikachu)"></div>
                        <div class="col-3"><input id="pk-level" type="number" min="1" max="100"
                                class="form-control form-control-dark form-control-sm" placeholder="Nivel"></div>
                        <div class="col-auto"><button type="button" class="btn btn-primary-custom btn-sm"
                                id="btn-addpk"><i class="fa-solid fa-plus"></i></button></div>
                    </div>
                </div>
            </div>

            <!-- Moderation -->
            <div id="v-mod" class="d-none">
                <div class="mod-search">
                    <h6><i class="fa-solid fa-magnifying-glass me-1" style="color:var(--accent)"></i> Buscar equipos de
                        usuario</h6>
                    <div class="row g-2 align-items-end">
                        <div class="col"><input id="mod-userid" type="number"
                                class="form-control form-control-dark form-control-sm" placeholder="ID del usuario">
                        </div>
                        <div class="col-auto"><button type="button" class="btn btn-primary-custom btn-sm"
                                id="btn-mod-search"><i class="fa-solid fa-search me-1"></i> Buscar</button></div>
                    </div>
                </div>
                <div id="mod-results" class="d-none">
                    <div class="section-header">
                        <h4 id="mod-user-title"></h4>
                    </div>
                    <div id="mod-teams-list" class="d-flex flex-column gap-2"></div>
                    <div id="mod-no-teams" class="empty-state d-none">
                        <i class="fa-solid fa-box-open"></i>
                        <p>Este usuario no tiene equipos.</p>
                    </div>
                </div>
            </div>

            <!-- Moderation: Team Detail -->
            <div id="v-mod-team" class="d-none">
                <button type="button" class="btn btn-ghost btn-sm mb-3" id="btn-mod-back"><i
                        class="fa-solid fa-arrow-left me-1"></i> Volver</button>
                <div class="section-header">
                    <h4 id="mod-team-name"></h4>
                    <button type="button" class="btn btn-ghost btn-ghost-danger btn-sm" id="btn-mod-delteam"><i
                            class="fa-solid fa-trash me-1"></i> Eliminar equipo</button>
                </div>
                <div id="mod-pokemon-list" class="row g-3"></div>
                <div id="mod-no-pokemon" class="empty-state d-none">
                    <i class="fa-solid fa-ghost"></i>
                    <p>Este equipo está vacío.</p>
                </div>
            </div>

            <!-- Admin -->
            <div id="v-admin" class="d-none">
                <div class="section-header">
                    <h4><i class="fa-solid fa-crown me-2" style="color:var(--accent)"></i>Usuarios</h4>
                    <button type="button" class="btn btn-ghost btn-sm" id="btn-refresh-users"><i
                            class="fa-solid fa-refresh me-1"></i> Actualizar</button>
                </div>
                <div class="card-dark">
                    <div class="card-body" style="padding:0;overflow-x:auto">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="no-users" class="empty-state d-none">
                    <i class="fa-solid fa-users-slash"></i>
                    <p>No hay usuarios registrados.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="modalNew" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo equipo</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><input id="new-team-name" class="form-control form-control-dark"
                        placeholder="Nombre del equipo"></div>
                <div class="modal-footer"><button type="button" class="btn btn-primary-custom" id="btn-createteam">Crear
                        equipo</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalRename" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Renombrar equipo</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><input id="rename-input" class="form-control form-control-dark"
                        placeholder="Nuevo nombre"></div>
                <div class="modal-footer"><button type="button" class="btn btn-primary-custom"
                        id="btn-savename">Guardar</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDelTeam" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Eliminar equipo</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">¿Seguro que quieres eliminar este equipo y todos sus Pokémon?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom btn-sm" id="btn-confirmdelteam"><i
                            class="fa-solid fa-trash me-1"></i> Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDelPk" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quitar Pokémon</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">¿Quitar este Pokémon del equipo?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom btn-sm" id="btn-confirmdelpk"><i
                            class="fa-solid fa-times me-1"></i> Quitar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Delete user team (moderation) -->
    <div class="modal fade" id="modalModDelTeam" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Eliminar equipo de usuario</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">¿Seguro que quieres eliminar este equipo y todos sus Pokémon?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom btn-sm" id="btn-confirm-mod-delteam"><i
                            class="fa-solid fa-trash me-1"></i> Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Delete user team Pokemon (moderation) -->
    <div class="modal fade" id="modalModDelPk" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quitar Pokémon de usuario</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">¿Quitar este Pokémon del equipo del usuario?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom btn-sm" id="btn-confirm-mod-delpk"><i
                            class="fa-solid fa-times me-1"></i> Quitar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Delete user (admin) -->
    <div class="modal fade" id="modalDelUser" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Eliminar usuario</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">¿Seguro que quieres eliminar este usuario y todos sus datos?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom btn-sm" id="btn-confirm-deluser"><i
                            class="fa-solid fa-trash me-1"></i> Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // ====== CONFIGURACIÓN ======
        var API = "";
        // ===========================

        var token = localStorage.getItem("ptb_token") || null;
        var storedUser = localStorage.getItem("ptb_user") || "";
        var userRole = localStorage.getItem("ptb_role") || "user";
        var currentTeamId = null;
        var pendingDeletePkId = null;
        var modUserId = null;
        var modTeamId = null;
        var pendingModDeletePkId = null;
        var pendingDeleteUserId = null;

        function saveSession() {
            if (token) localStorage.setItem("ptb_token", token); else localStorage.removeItem("ptb_token");
            if (storedUser) localStorage.setItem("ptb_user", storedUser); else localStorage.removeItem("ptb_user");
            if (userRole) localStorage.setItem("ptb_role", userRole); else localStorage.removeItem("ptb_role");
        }

        window.onerror = function (m) { console.error("[PTB]", m); return true; };
        window.addEventListener("unhandledrejection", function (e) { console.error("[PTB]", e.reason); e.preventDefault(); });

        function go(id) {
            document.querySelectorAll(".sec").forEach(function (s) { s.classList.remove("on"); });
            document.getElementById(id).classList.add("on");
        }

        function modal(id, show) {
            var el = document.getElementById(id);
            var m = bootstrap.Modal.getOrCreateInstance(el);
            if (show) m.show(); else m.hide();
        }

        function notify(msg, type) {
            type = type || "danger";
            var t = document.getElementById("toast");
            t.className = "toast align-items-center text-bg-" + type + " border-0";
            document.getElementById("toast-msg").textContent = msg;
            bootstrap.Toast.getOrCreateInstance(t).show();
        }

        function api(path, opts) {
            opts = opts || {};
            var h = { "Content-Type": "application/json" };
            if (token) h["Authorization"] = "Bearer " + token;
            return fetch(API + path, { method: opts.method || "GET", headers: h, body: opts.body || undefined })
                .then(function (r) {
                    var refreshed = r.headers.get("X-Refreshed-Token");
                    if (refreshed) { token = refreshed; saveSession(); }
                    if (!r.ok) {
                        return r.json().catch(function () { return {}; }).then(function (e) {
                            throw new Error(typeof e.detail === "string" ? e.detail : "Error " + r.status);
                        });
                    }
                    return r.text().then(function (txt) { return txt ? JSON.parse(txt) : null; });
                });
        }

        function updateRoleUI() {
            var badge = document.getElementById("nav-role-badge");
            badge.textContent = userRole;
            badge.className = "role-badge role-" + userRole;
            var navMod = document.getElementById("nav-mod");
            var navAdmin = document.getElementById("nav-admin");
            if (userRole === "moderator" || userRole === "admin") {
                navMod.classList.remove("d-none");
            } else {
                navMod.classList.add("d-none");
            }
            if (userRole === "admin") {
                navAdmin.classList.remove("d-none");
            } else {
                navAdmin.classList.add("d-none");
            }
        }

        function switchView(view) {
            var allViews = ["v-teams", "v-team", "v-mod", "v-mod-team", "v-admin"];
            allViews.forEach(function (v) { document.getElementById(v).classList.add("d-none"); });
            document.querySelectorAll(".main-nav .nav-btn").forEach(function (b) { b.classList.remove("active"); });
            var activeBtn = document.querySelector('.main-nav .nav-btn[data-view="' + view + '"]');
            if (activeBtn) activeBtn.classList.add("active");
            if (view === "teams") {
                document.getElementById("v-teams").classList.remove("d-none");
                showTeams();
            } else if (view === "mod") {
                document.getElementById("v-mod").classList.remove("d-none");
            } else if (view === "admin") {
                document.getElementById("v-admin").classList.remove("d-none");
                loadUsers();
            }
        }

        // Sprites
        var spriteCache = {};
        function getSprite(sp) {
            var k = sp.toLowerCase().trim();
            if (spriteCache[k]) return Promise.resolve(spriteCache[k]);
            return fetch("https://pokeapi.co/api/v2/pokemon/" + k)
                .then(function (r) { return r.ok ? r.json() : null; })
                .then(function (d) {
                    if (!d) return "";
                    var u = d.sprites.other["official-artwork"].front_default || d.sprites.front_default || "";
                    spriteCache[k] = u; return u;
                }).catch(function () { return ""; });
        }

        // Teams
        function showTeams() {
            document.getElementById("v-teams").classList.remove("d-none");
            document.getElementById("v-team").classList.add("d-none");
            api("/teams/").then(function (teams) {
                var c = document.getElementById("teams-list"); c.innerHTML = "";
                document.getElementById("no-teams").classList.toggle("d-none", teams.length > 0);
                teams.forEach(function (t) {
                    var d = document.createElement("div");
                    d.className = "team-card fade-in";
                    d.innerHTML = '<span class="team-name"><i class="fa-solid fa-pokeball me-2" style="color:var(--accent)"></i>' + t.name + '</span><span class="team-id">#' + t.id + '</span>';
                    d.addEventListener("click", function (e) { e.preventDefault(); openTeam(t.id, t.name); });
                    c.appendChild(d);
                });
            }).catch(function (e) { notify(e.message); });
        }

        function openTeam(id, name) {
            currentTeamId = id;
            document.getElementById("v-teams").classList.add("d-none");
            document.getElementById("v-team").classList.remove("d-none");
            document.getElementById("team-name").textContent = name;
            loadPokemon();
        }

        function loadPokemon() {
            api("/teams/" + currentTeamId).then(function (data) {
                document.getElementById("team-name").textContent = data.name;
                var c = document.getElementById("pokemon-list"); c.innerHTML = "";
                var pk = data.pokemon || [];
                document.getElementById("no-pokemon").classList.toggle("d-none", pk.length > 0);
                document.getElementById("add-pokemon-section").classList.toggle("d-none", pk.length >= 6);
                var chain = Promise.resolve();
                pk.forEach(function (p) {
                    chain = chain.then(function () {
                        return getSprite(p.species).then(function (sp) {
                            var col = document.createElement("div"); col.className = "col-6 col-md-4 fade-in";
                            col.innerHTML = '<div class="pk-card">' +
                                '<div class="pk-img-wrap">' +
                                (sp ? '<img src="' + sp + '" alt="' + p.species + '">' : '<div style="font-size:2.5rem;opacity:.3">❓</div>') +
                                '</div><div class="pk-info">' +
                                '<p class="pk-name">' + p.name + '</p>' +
                                '<span class="pk-species">' + p.species + '</span><br>' +
                                '<span class="pk-level">Nv. ' + p.level + '</span>' +
                                '</div><button type="button" class="pk-remove"><i class="fa-solid fa-times me-1"></i> Quitar</button></div>';
                            col.querySelector(".pk-remove").addEventListener("click", function (e) {
                                e.preventDefault(); e.stopPropagation();
                                pendingDeletePkId = p.id; modal("modalDelPk", true);
                            });
                            c.appendChild(col);
                        });
                    });
                });
            }).catch(function (e) { notify(e.message); });
        }

        // ====== MODERATION ======
        function searchUserTeams() {
            var uid = document.getElementById("mod-userid").value.trim();
            if (!uid) { notify("Introduce un ID de usuario"); return; }
            modUserId = parseInt(uid);
            api("/users/" + modUserId + "/teams").then(function (teams) {
                document.getElementById("mod-results").classList.remove("d-none");
                document.getElementById("mod-user-title").textContent = "Equipos del usuario #" + modUserId;
                var c = document.getElementById("mod-teams-list"); c.innerHTML = "";
                document.getElementById("mod-no-teams").classList.toggle("d-none", teams.length > 0);
                teams.forEach(function (t) {
                    var d = document.createElement("div");
                    d.className = "team-card fade-in";
                    d.innerHTML = '<span class="team-name"><i class="fa-solid fa-pokeball me-2" style="color:var(--accent)"></i>' + t.name + '</span><span class="team-id">#' + t.id + '</span>';
                    d.addEventListener("click", function (e) { e.preventDefault(); openModTeam(t.id, t.name); });
                    c.appendChild(d);
                });
            }).catch(function (e) { notify(e.message); });
        }

        function openModTeam(teamId, name) {
            modTeamId = teamId;
            document.getElementById("v-mod").classList.add("d-none");
            document.getElementById("v-mod-team").classList.remove("d-none");
            document.getElementById("mod-team-name").textContent = name;
            loadModPokemon();
        }

        function loadModPokemon() {
            api("/users/" + modUserId + "/teams/" + modTeamId).then(function (data) {
                document.getElementById("mod-team-name").textContent = data.name;
                var c = document.getElementById("mod-pokemon-list"); c.innerHTML = "";
                var pk = data.pokemon || [];
                document.getElementById("mod-no-pokemon").classList.toggle("d-none", pk.length > 0);
                var chain = Promise.resolve();
                pk.forEach(function (p) {
                    chain = chain.then(function () {
                        return getSprite(p.species).then(function (sp) {
                            var col = document.createElement("div"); col.className = "col-6 col-md-4 fade-in";
                            col.innerHTML = '<div class="pk-card">' +
                                '<div class="pk-img-wrap">' +
                                (sp ? '<img src="' + sp + '" alt="' + p.species + '">' : '<div style="font-size:2.5rem;opacity:.3">❓</div>') +
                                '</div><div class="pk-info">' +
                                '<p class="pk-name">' + p.name + '</p>' +
                                '<span class="pk-species">' + p.species + '</span><br>' +
                                '<span class="pk-level">Nv. ' + p.level + '</span>' +
                                '</div><button type="button" class="pk-remove"><i class="fa-solid fa-times me-1"></i> Quitar</button></div>';
                            col.querySelector(".pk-remove").addEventListener("click", function (e) {
                                e.preventDefault(); e.stopPropagation();
                                pendingModDeletePkId = p.id; modal("modalModDelPk", true);
                            });
                            c.appendChild(col);
                        });
                    });
                });
            }).catch(function (e) { notify(e.message); });
        }

        // ====== ADMIN ======
        function loadUsers() {
            api("/users/").then(function (users) {
                var tbody = document.getElementById("users-tbody"); tbody.innerHTML = "";
                document.getElementById("no-users").classList.toggle("d-none", users.length > 0);
                users.forEach(function (u) {
                    var tr = document.createElement("tr"); tr.className = "fade-in";
                    tr.innerHTML = '<td>' + u.id + '</td>' +
                        '<td><strong>' + u.username + '</strong></td>' +
                        '<td><span class="role-badge role-' + u.role + '">' + u.role + '</span></td>' +
                        '<td><div class="d-flex gap-2 align-items-center">' +
                        '<select class="select-dark" data-uid="' + u.id + '">' +
                        '<option value="user"' + (u.role === "user" ? ' selected' : '') + '>user</option>' +
                        '<option value="moderator"' + (u.role === "moderator" ? ' selected' : '') + '>moderator</option>' +
                        '<option value="admin"' + (u.role === "admin" ? ' selected' : '') + '>admin</option>' +
                        '</select>' +
                        '<button type="button" class="btn btn-ghost btn-ghost-danger btn-sm btn-del-user" data-uid="' + u.id + '" data-uname="' + u.username + '">' +
                        '<i class="fa-solid fa-trash"></i></button></div></td>';
                    var sel = tr.querySelector("select");
                    sel.addEventListener("change", function () {
                        var newRole = sel.value;
                        api("/users/" + u.id + "/role", {
                            method: "PATCH", body: JSON.stringify({ role: newRole })
                        }).then(function () {
                            notify("Rol actualizado a " + newRole, "success");
                            loadUsers();
                        }).catch(function (e) { notify(e.message); sel.value = u.role; });
                    });
                    tr.querySelector(".btn-del-user").addEventListener("click", function (e) {
                        e.preventDefault();
                        pendingDeleteUserId = u.id;
                        document.getElementById("modalDelUser").querySelector(".modal-body").textContent =
                            "¿Seguro que quieres eliminar al usuario \"" + u.username + "\" y todos sus datos?";
                        modal("modalDelUser", true);
                    });
                    tbody.appendChild(tr);
                });
            }).catch(function (e) { notify(e.message); });
        }

        // Restore session
        if (token) {
            document.getElementById("nav-username").textContent = storedUser;
            document.getElementById("nav-user").classList.remove("d-none");
            updateRoleUI();
            go("sec-main");
            setTimeout(showTeams, 50);
        } else {
            go("sec-auth");
        }

        // Events
        document.getElementById("tab-login").addEventListener("click", function (e) {
            e.preventDefault();
            document.getElementById("tab-login").classList.add("active");
            document.getElementById("tab-register").classList.remove("active");
            document.getElementById("form-login").classList.remove("d-none");
            document.getElementById("form-register").classList.add("d-none");
        });

        document.getElementById("tab-register").addEventListener("click", function (e) {
            e.preventDefault();
            document.getElementById("tab-register").classList.add("active");
            document.getElementById("tab-login").classList.remove("active");
            document.getElementById("form-register").classList.remove("d-none");
            document.getElementById("form-login").classList.add("d-none");
        });

        document.getElementById("btn-login").addEventListener("click", function (e) {
            e.preventDefault();
            api("/auth/login", {
                method: "POST",
                body: JSON.stringify({ username: document.getElementById("l-user").value, password: document.getElementById("l-pass").value })
            }).then(function (d) {
                if (typeof d === "string") token = d;
                else token = d.access_token || d.token || "";
                if (!token) { notify("No se pudo obtener el token"); return; }
                storedUser = document.getElementById("l-user").value;
                userRole = d.role || "user";
                saveSession();
                document.getElementById("nav-username").textContent = storedUser;
                document.getElementById("nav-user").classList.remove("d-none");
                updateRoleUI();
                go("sec-main"); showTeams();
            }).catch(function (e) { notify(e.message); });
        });

        document.getElementById("btn-register").addEventListener("click", function (e) {
            e.preventDefault();
            api("/auth/register", {
                method: "POST",
                body: JSON.stringify({ username: document.getElementById("r-user").value, password: document.getElementById("r-pass").value })
            }).then(function () {
                notify("Cuenta creada. Inicia sesión.", "success");
                document.getElementById("tab-login").click();
            }).catch(function (e) { notify(e.message); });
        });

        document.getElementById("btn-logout").addEventListener("click", function (e) {
            e.preventDefault(); token = null; currentTeamId = null; storedUser = ""; userRole = "user";
            modUserId = null; modTeamId = null;
            saveSession();
            document.getElementById("nav-user").classList.add("d-none"); go("sec-auth");
        });

        document.getElementById("btn-newteam").addEventListener("click", function (e) { e.preventDefault(); modal("modalNew", true); });

        document.getElementById("btn-createteam").addEventListener("click", function (e) {
            e.preventDefault();
            var name = document.getElementById("new-team-name").value.trim();
            if (!name) return;
            api("/teams/", { method: "POST", body: JSON.stringify({ name: name }) }).then(function () {
                modal("modalNew", false);
                document.getElementById("new-team-name").value = "";
                notify("Equipo creado", "success"); showTeams();
            }).catch(function (e) { notify(e.message); });
        });

        document.getElementById("btn-back").addEventListener("click", function (e) { e.preventDefault(); showTeams(); });

        document.getElementById("btn-rename").addEventListener("click", function (e) {
            e.preventDefault();
            document.getElementById("rename-input").value = document.getElementById("team-name").textContent;
            modal("modalRename", true);
        });

        document.getElementById("btn-savename").addEventListener("click", function (e) {
            e.preventDefault();
            var n = document.getElementById("rename-input").value.trim();
            if (!n) return;
            api("/teams/" + currentTeamId, { method: "PATCH", body: JSON.stringify({ name: n }) }).then(function () {
                document.getElementById("team-name").textContent = n;
                modal("modalRename", false); notify("Renombrado", "success");
            }).catch(function (e) { notify(e.message); });
        });

        document.getElementById("btn-delteam").addEventListener("click", function (e) { e.preventDefault(); modal("modalDelTeam", true); });

        document.getElementById("btn-confirmdelteam").addEventListener("click", function (e) {
            e.preventDefault();
            api("/teams/" + currentTeamId, { method: "DELETE" }).then(function () {
                modal("modalDelTeam", false); notify("Equipo eliminado", "success"); showTeams();
            }).catch(function (e) { notify(e.message); });
        });

        document.getElementById("btn-addpk").addEventListener("click", function (e) {
            e.preventDefault();
            var name = document.getElementById("pk-name").value.trim();
            var species = document.getElementById("pk-species").value.trim();
            var level = parseInt(document.getElementById("pk-level").value);
            if (!name || !species || !level) { notify("Rellena todos los campos"); return; }
            api("/teams/" + currentTeamId + "/pokemon", {
                method: "POST", body: JSON.stringify({ name: name, species: species, level: level })
            }).then(function () {
                document.getElementById("pk-name").value = "";
                document.getElementById("pk-species").value = "";
                document.getElementById("pk-level").value = "";
                notify("Pokémon añadido", "success"); loadPokemon();
            }).catch(function (e) { notify(e.message); });
        });

        document.getElementById("btn-confirmdelpk").addEventListener("click", function (e) {
            e.preventDefault();
            api("/teams/" + currentTeamId + "/pokemon/" + pendingDeletePkId, { method: "DELETE" }).then(function () {
                modal("modalDelPk", false); loadPokemon();
            }).catch(function (e) { notify(e.message); });
        });

        // Main nav tab switching
        document.querySelectorAll(".main-nav .nav-btn").forEach(function (btn) {
            btn.addEventListener("click", function (e) {
                e.preventDefault();
                switchView(btn.getAttribute("data-view"));
            });
        });

        // ====== MODERATION EVENTS ======
        document.getElementById("btn-mod-search").addEventListener("click", function (e) {
            e.preventDefault(); searchUserTeams();
        });

        document.getElementById("mod-userid").addEventListener("keydown", function (e) {
            if (e.key === "Enter") { e.preventDefault(); searchUserTeams(); }
        });

        document.getElementById("btn-mod-back").addEventListener("click", function (e) {
            e.preventDefault();
            document.getElementById("v-mod-team").classList.add("d-none");
            document.getElementById("v-mod").classList.remove("d-none");
        });

        document.getElementById("btn-mod-delteam").addEventListener("click", function (e) {
            e.preventDefault(); modal("modalModDelTeam", true);
        });

        document.getElementById("btn-confirm-mod-delteam").addEventListener("click", function (e) {
            e.preventDefault();
            api("/users/" + modUserId + "/teams/" + modTeamId, { method: "DELETE" }).then(function () {
                modal("modalModDelTeam", false);
                notify("Equipo eliminado", "success");
                document.getElementById("v-mod-team").classList.add("d-none");
                document.getElementById("v-mod").classList.remove("d-none");
                searchUserTeams();
            }).catch(function (e) { notify(e.message); });
        });

        document.getElementById("btn-confirm-mod-delpk").addEventListener("click", function (e) {
            e.preventDefault();
            api("/users/" + modUserId + "/teams/" + modTeamId + "/pokemon/" + pendingModDeletePkId, { method: "DELETE" }).then(function () {
                modal("modalModDelPk", false);
                notify("Pokémon eliminado", "success");
                loadModPokemon();
            }).catch(function (e) { notify(e.message); });
        });

        // ====== ADMIN EVENTS ======
        document.getElementById("btn-refresh-users").addEventListener("click", function (e) {
            e.preventDefault(); loadUsers();
        });

        document.getElementById("btn-confirm-deluser").addEventListener("click", function (e) {
            e.preventDefault();
            api("/users/" + pendingDeleteUserId, { method: "DELETE" }).then(function () {
                modal("modalDelUser", false);
                notify("Usuario eliminado", "success");
                loadUsers();
            }).catch(function (e) { notify(e.message); });
        });
    </script>
</body>

</html>